---
title: "SVGs spNNGP analyses"
author: "Lukas Weber"
date: "`R Sys.Date()`"
output: html_document
---

# Introduction

Analyses for SVGs spNNGP method - including evaluations of test statistic properties, comparisons with HVGs, and runtimes.

```{r, eval=FALSE}
# start session on cluster
screen -S svgs_analyses
qrsh -l mem_free=10G,h_vmem=12G,h_fsize=100G
cd /dcs04/hicks/data/lweber/SVGs_spNNGP/SVGs-spNNGP-analyses
module load conda_R/devel
R
```


## Load results

Load results saved in object from script `SVGs_spNNGP_humanDLPFC_spatzli.R`. The results are stored in the `rowData` of the `SpatialExperiment` object.

```{r, message=FALSE}
library(SpatialExperiment)
library(spatzli)

load("outputs/spe_spnngp.RData")
```


## Evaluations of statistic

Evaluations of the properties of the statistic across genes.

```{r, message=FALSE}
library(ggplot2)
```

```{r}
# calculate total UMIs per gene
rowData(spe)$sum <- rowSums(counts(spe))
# calculate mean logcounts per gene
rowData(spe)$mean <- rowMeans(logcounts(spe))

# loess fit to mean logcounts
# note: handle NAs
is_nas <- is.na(rowData(spe)$stat)
trend <- predict(loess(rowData(spe)$stat[!is_nas] ~ rowData(spe)$mean[!is_nas]))
rowData(spe)$trend <- NA
rowData(spe)$trend[!is_nas] <- trend

# calculate difference above trend
rowData(spe)$difftrend <- rowData(spe)$stat - rowData(spe)$trend
# ranking by difference above trend
rowData(spe)$rank_trend <- rank(-1 * rowData(spe)$difftrend, na.last = "keep")

# check for top genes
ix_svgs <- which(rowData(spe)$rank <= 10)
ix_svgs_trend <- which(rowData(spe)$rank_trend <= 10)
ix_hvgs <- which(rowData(spe)$rank_hvgs <= 10)

ix <- union(union(ix_svgs, ix_svgs_trend), ix_hvgs)
length(ix)
as.data.frame(rowData(spe)[ix, ])
```

```{r, fig.width=4.5, fig.height=4}
df <- as.data.frame(rowData(spe))

# plots

# spNNGP statistic vs. mean logcounts
ix_nas <- is.na(df$stat)
ggplot(df[!ix_nas, ], aes(x = mean, y = stat)) + 
  geom_point() + 
  geom_line(aes(x = mean, y = trend), color = "blue", size = 1) + 
  labs(
    x = "mean logcounts", 
    y = "statistic", 
    title = "spNNGP SVGs statistic"
  ) + 
  theme_bw()
ggsave("plots/spNNGP_vs_logcounts.png", width = 5.5, height = 5)

# spNNGP statistic rank vs. trend
ix_nas <- is.na(df$rank_trend)
ggplot(df[!ix_nas, ], aes(x = difftrend, y = rank_trend)) + 
  geom_point() + 
  labs(
    x = "statistic (difference vs. trend)", 
    y = "rank (difference vs. trend)", 
    title = "spNNGP SVGs statistic"
  ) + 
  theme_bw()
ggsave("plots/spNNGP_rank_vs_difftrend.png", width = 5.5, height = 5)

# spNNGP statistic rank vs. HVGs rank
ix_nas <- is.na(df$rank_trend) | is.na(df$rank_hvgs)
ggplot(df[!ix_nas, ], aes(x = rank_hvgs, y = rank_trend)) + 
  geom_point() + 
  labs(
    x = "rank of HVGs", 
    y = "rank of SVGs (difference vs. trend)", 
    title = "spNNGP SVGs ranks"
  ) + 
  theme_bw()
ggsave("plots/spNNGP_rank_vs_HVGs_rank.png", width = 5.5, height = 5)
```


