---
title: "Evaluations of SVGs methods: mOB dataset"
author: "Lukas Weber"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE)
```


# Introduction

Evaluations of SVGs methods:

- mOB dataset
- using implementation of BRISC method in nnSVG package

```{r, message = FALSE}
library(SpatialExperiment)
library(STexampleData)
library(nnSVG)
library(dplyr)
library(tidyr)
library(ggplot2)
```


---

# Load data and preprocessing


## Load data

Load dataset from MERINGUE package and reshape into `SpatialExperiment` format.

```{r, message=FALSE}
library(MERINGUE)
```

```{r}
# load dataset from MERINGUE package
data(mOB)

names(mOB)
dim(mOB$counts)
mOB$counts[1000:1006, 1:6]
head(mOB$pos)
head(mOB$results)
str(mOB$annot)

# create SpatialExperiment
row_data <- data.frame(
  gene_name = rownames(mOB$counts)
)
res <- cbind(mOB$results, gene_name = rownames(mOB$results))
row_data <- DataFrame(left_join(row_data, res, by = "gene_name"))
head(row_data)

col_data <- data.frame(
  barcode_id = colnames(mOB$counts)
)
annot <- data.frame(
  barcode_id = names(mOB$annot), 
  layer_id = mOB$annot
)
col_data <- DataFrame(left_join(col_data, annot, by = "barcode_id"))
head(col_data)

spatial_coords <- as.matrix(mOB$pos[col_data$barcode_id, ])
head(spatial_coords)

stopifnot(nrow(spatial_coords) == nrow(col_data))
stopifnot(all(rownames(spatial_coords) == col_data$barcode_id))
stopifnot(all(colnames(mOB$counts) == col_data$barcode_id))

spe <- SpatialExperiment(
  assays = list(counts = mOB$counts), 
  rowData = row_data, 
  colData = col_data, 
  spatialCoords = spatial_coords
)

spe
```


## Preprocessing

Preprocessing steps: filter low-expressed genes, filter mitochondrial genes, normalization, calculate logcounts.

Using convenience function in `nnSVG` package.

```{r}
set.seed(123)
spe <- preprocessSVG(spe, in_tissue = FALSE)

dim(spe)
assayNames(spe)

logcounts(spe)[1:6, 1:6]
```


## Clustering

Clustering to identify major cell types, which can be provided as a covariate in the `nnSVG` model.

```{r}
set.seed(123)
spe <- clusterSVG(spe)

colData(spe)

# compare against ground truth labels
table(truth = colData(spe)$layer_id, 
      clusters = colData(spe)$label)
```


---

# Identify SVGs

## nnSVG: all spots

Using implementation of BRISC method in nnSVG package.

```{r}
library(nnSVG)

# run nnSVG across all spots
system.time({
  spe_all <- nnSVG(spe, n_threads = 4)
})
```


## nnSVG: within cell types

```{r}
# build model matrix using cell type labels from clustering
X <- model.matrix(~ colData(spe)$label)
dim(X)
head(X)
stopifnot(nrow(X) == ncol(spe))

# run nnSVG taking cell types into account
system.time({
  spe_clusters <- nnSVG(spe, x = X, n_threads = 4)
})
```


---

# Session info

```{r}
sessionInfo()
```

